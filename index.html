<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ruta Optimizada con Rotación Plana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- MapLibre GL -->
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      position: absolute;
      top: 0; bottom: 0; left: 0; right: 0;
    }

    #panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      z-index: 999;
      width: 260px;
      font-size: 14px;
    }

    #panel button {
      width: 100%;
      padding: 8px;
      margin-bottom: 6px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    #lista {
      list-style: none;
      padding-left: 0;
      max-height: 160px;
      overflow-y: auto;
    }

    #lista li {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <button onclick="centrarUbicacion()">📍 Centrar ubicación</button>
  <button onclick="reiniciar()">🔄 Reiniciar ruta</button>
  <strong>Destinos:</strong>
  <ul id="lista"></ul>
</div>

<script>
  const ORS_API_KEY = "5b3ce3597851110001cf624841023b35821447ab8cb9659caa17eb9d";

  const map = new maplibregl.Map({
    container: 'map',
    style: 'https://demotiles.maplibre.org/style.json',
    center: [-71.96746, -13.53195], // Cusco
    zoom: 14,
    bearing: 0 // Solo rotación plana, sin pitch
  });

  map.addControl(new maplibregl.NavigationControl({ showCompass: true }), 'top-right');

  let ubicacionActual = null;
  let marcadorUbicacion = null;
  let destinos = [];
  let marcadores = [];
  let rutaLayer = null;

  navigator.geolocation.watchPosition(pos => {
    const coords = [pos.coords.longitude, pos.coords.latitude];
    ubicacionActual = coords;

    if (!marcadorUbicacion) {
      marcadorUbicacion = new maplibregl.Marker({ color: 'red' })
        .setLngLat(coords)
        .addTo(map);
    } else {
      marcadorUbicacion.setLngLat(coords);
    }
  }, err => console.error(err), {
    enableHighAccuracy: true,
    maximumAge: 1000
  });

  function centrarUbicacion() {
    if (ubicacionActual) map.flyTo({ center: ubicacionActual, zoom: 16 });
    else alert("Tu ubicación aún no se ha detectado.");
  }

  function actualizarLista(nombres) {
    const ul = document.getElementById('lista');
    ul.innerHTML = '';
    nombres.forEach((nombre, i) => {
      const li = document.createElement('li');
      li.textContent = `${i + 1}. ${nombre}`;
      ul.appendChild(li);
    });
  }

  function reiniciar() {
    destinos = [];
    marcadores.forEach(m => m.remove());
    marcadores = [];
    if (rutaLayer) {
      map.removeLayer('ruta');
      map.removeSource('ruta');
    }
    actualizarLista([]);
  }

  async function optimizarRuta() {
    if (destinos.length < 2) return;

    const jobs = destinos.map((dest, i) => ({
      id: i + 1,
      location: dest.coords
    }));

    const body = {
      jobs,
      vehicles: [{
        id: 1,
        profile: "foot-walking",
        start: destinos[0].coords
      }]
    };

    const response = await fetch("https://api.openrouteservice.org/optimization", {
      method: "POST",
      headers: {
        "Authorization": ORS_API_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    const data = await response.json();
    const steps = data.routes[0].steps;
    const ordenado = [destinos[0], ...steps.filter(s => s.type === 'job').map(s => destinos[s.job - 1])];

    const coordsOrdenados = ordenado.map(d => d.coords);
    const nombres = ordenado.map(d => d.nombre);
    actualizarLista(nombres);

    const geoResp = await fetch("https://api.openrouteservice.org/v2/directions/foot-walking/geojson", {
      method: "POST",
      headers: {
        "Authorization": ORS_API_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ coordinates: coordsOrdenados })
    });

    const geojson = await geoResp.json();

    if (rutaLayer) {
      map.getSource('ruta').setData(geojson);
    } else {
      map.addSource('ruta', {
        type: 'geojson',
        data: geojson
      });
      map.addLayer({
        id: 'ruta',
        type: 'line',
        source: 'ruta',
        paint: {
          'line-color': '#28a745',
          'line-width': 4
        }
      });
    }
  }

  map.on('click', async e => {
    const nombre = prompt("Nombre del destino:");
    if (!nombre) return;

    const coords = [e.lngLat.lng, e.lngLat.lat];
    destinos.push({ nombre, coords });

    const marker = new maplibregl.Marker()
      .setLngLat(coords)
      .setPopup(new maplibregl.Popup().setText(nombre))
      .addTo(map);

    marcadores.push(marker);
    await optimizarRuta();
  });
</script>

</body>
</html>
