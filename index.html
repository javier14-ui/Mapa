<!DOCTYPE html>
<html>
<head>
  <title>Gu√≠a de Viaje a Cusco</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet GeoSearch -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.css" />
  <script src="https://unpkg.com/leaflet-geosearch@3.11.0/dist/bundle.min.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #map {
      height: 100vh;
      width: 100vw;
      transition: transform 0.3s ease;
      transform-origin: center center;
      overflow: hidden;
    }

    #panel {
      position: absolute;
      top: 70px;
      left: 10px;
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 999;
    }

    #panel button {
      margin-bottom: 8px;
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #reiniciar-btn { background: #d9534f; color: white; }
    #centrar-btn { background: #0275d8; color: white; }
    #rotar-izq-btn, #rotar-der-btn { background: #5bc0de; color: white; }

    #info {
      margin: 10px 0;
      font-weight: bold;
      font-size: 14px;
    }

    ul#listaDestinos {
      list-style: none;
      padding-left: 0;
      font-size: 13px;
    }

    ul#listaDestinos li {
      padding: 5px 0;
      border-bottom: 1px solid #ccc;
    }

    /* B√∫squeda visible */
    .leaflet-control-geosearch {
      z-index: 1000 !important;
    }

    .leaflet-control-geosearch form {
      position: relative !important;
      z-index: 1001 !important;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <button id="reiniciar-btn" onclick="reiniciarRuta()">üîÑ Reiniciar ruta</button>
  <button id="centrar-btn" onclick="centrarEnMiUbicacion()">üìç Centrar ubicaci√≥n</button>
  <button id="rotar-izq-btn" onclick="rotarMapa(-15)">‚§∫ Rotar izquierda</button>
  <button id="rotar-der-btn" onclick="rotarMapa(15)">‚§ª Rotar derecha</button>
  <div id="info">Haz clic en el mapa para agregar destinos.</div>
  <ul id="listaDestinos"></ul>
</div>

<script>
  const apiKey = "5b3ce3597851110001cf624841023b35821447ab8cb9659caa17eb9d";
  let currentRotation = 0;

  const map = L.map('map').setView([-13.53195, -71.96746], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  // Buscador
  const provider = new GeoSearch.OpenStreetMapProvider();
  const searchControl = new GeoSearch.GeoSearchControl({
    provider,
    style: 'bar',
    searchLabel: 'Buscar lugares...',
    autoComplete: true,
    autoClose: true,
    keepResult: true
  });
  map.addControl(searchControl);
  document.querySelector('.leaflet-control-geosearch').style.marginTop = '10px';

  let destinos = [];
  let marcadores = [];
  let rutaActual = null;
  let marcadorUbicacion = null;

  function mostrarUbicacionEnVivo() {
    if (!navigator.geolocation) {
      alert("Tu navegador no soporta geolocalizaci√≥n.");
      return;
    }

    navigator.geolocation.watchPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const nuevaPos = [lat, lng];

        if (!marcadorUbicacion) {
          marcadorUbicacion = L.marker(nuevaPos).addTo(map);
        } else {
          marcadorUbicacion.setLatLng(nuevaPos);
        }
      },
      (err) => {
        alert("No se pudo obtener la ubicaci√≥n.");
        console.error(err);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 1000
      }
    );
  }

  mostrarUbicacionEnVivo();

  function centrarEnMiUbicacion() {
    if (marcadorUbicacion) {
      map.setView(marcadorUbicacion.getLatLng(), 16);
    } else {
      alert("Ubicaci√≥n a√∫n no detectada.");
    }
  }

  map.on('click', async function(e) {
    const nombre = prompt("¬øC√≥mo se llama este lugar?");
    if (!nombre) return;

    const latlng = e.latlng;
    const destino = { nombre, location: [latlng.lng, latlng.lat] };
    destinos.push(destino);

    const marcador = L.marker(latlng).addTo(map)
      .bindPopup(nombre).openPopup();
    marcadores.push(marcador);

    actualizarLista(destinos.map(d => d.nombre));

    if (destinos.length >= 3) {
      document.getElementById("info").innerText = "Calculando ruta optimizada...";

      try {
        const body = {
          jobs: destinos.map((dest, i) => ({
            id: i + 1,
            location: dest.location
          })),
          vehicles: [{
            id: 1,
            profile: "foot-walking",
            start: destinos[0].location
          }]
        };

        const optResponse = await fetch("https://api.openrouteservice.org/optimization", {
          method: "POST",
          headers: {
            "Authorization": apiKey,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        const optData = await optResponse.json();

        const ordenOptimizado = [
          destinos[0].location,
          ...optData.routes[0].steps
            .filter(step => step.type === "job")
            .map(step => destinos[step.job - 1].location)
        ];

        const nombresOrdenados = [
          destinos[0].nombre,
          ...optData.routes[0].steps
            .filter(step => step.type === "job")
            .map(step => destinos[step.job - 1].nombre)
        ];

        actualizarLista(nombresOrdenados);

        const rutaResponse = await fetch("https://api.openrouteservice.org/v2/directions/foot-walking/geojson", {
          method: "POST",
          headers: {
            "Authorization": apiKey,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ coordinates: ordenOptimizado })
        });

        const geojson = await rutaResponse.json();

        if (rutaActual) map.removeLayer(rutaActual);
        rutaActual = L.geoJSON(geojson, {
          style: { color: 'green', weight: 5 }
        }).addTo(map);

        const distanciaKm = geojson.features[0].properties.summary.distance / 1000;
        const duracionMin = geojson.features[0].properties.summary.duration / 60;
        document.getElementById("info").innerText =
          `‚úÖ Ruta optimizada: ${distanciaKm.toFixed(2)} km en ${duracionMin.toFixed(0)} min`;

      } catch (error) {
        console.error("Error:", error);
        document.getElementById("info").innerText = "‚ùå Error al calcular la ruta.";
      }
    }
  });

  function actualizarLista(lista) {
    const ul = document.getElementById("listaDestinos");
    ul.innerHTML = "";
    lista.forEach((nombre, i) => {
      const li = document.createElement("li");
      li.textContent = `${i + 1}. ${nombre}`;
      ul.appendChild(li);
    });
  }

  function reiniciarRuta() {
    destinos = [];
    marcadores.forEach(m => map.removeLayer(m));
    marcadores = [];
    if (rutaActual) map.removeLayer(rutaActual);
    rutaActual = null;
    document.getElementById("info").innerText = "Haz clic en el mapa para agregar destinos.";
    actualizarLista([]);
  }

  function rotarMapa(grados) {
    currentRotation = (currentRotation + grados) % 360;
    const mapDiv = document.getElementById("map");
    const pane = map.getPane("mapPane");
    mapDiv.style.transform = `rotate(${currentRotation}deg)`;
    pane.style.transform = `rotate(${-currentRotation}deg)`;
  }
</script>

</body>
</html>
