<!DOCTYPE html>
<html>
<head>
  <title>Ruta Optimizada con Seguimiento</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet GeoSearch -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.css" />
  <script src="https://unpkg.com/leaflet-geosearch@3.11.0/dist/bundle.min.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      height: 100vh;
      width: 100vw;
      touch-action: none; /* Permite rotar y hacer zoom con 2 dedos */
    }

    #panel {
      position: absolute;
      top: 60px;
      left: 10px;
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 999;
      max-height: 90vh;
      overflow-y: auto;
    }

    button {
      padding: 8px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 8px;
      width: 100%;
    }

    #reiniciar-btn {
      background: #d9534f;
    }

    #info {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 14px;
    }

    ul#listaDestinos {
      list-style: none;
      padding-left: 0;
      font-size: 14px;
    }

    ul#listaDestinos li {
      padding: 5px 0;
      border-bottom: 1px solid #ccc;
    }

    #ubicacion-coords {
      font-size: 12px;
      margin-top: 5px;
      color: gray;
    }

    .leaflet-control-geosearch {
      z-index: 1000 !important;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <button id="reiniciar-btn" onclick="reiniciarRuta()">üîÑ Reiniciar ruta</button>
  <button onclick="centrarEnMiUbicacion()">üìç Centrar en mi ubicaci√≥n</button>
  <button onclick="alternarSeguimiento()">üß≠ Activar seguimiento</button>
  <div id="info">Haz clic en el mapa para agregar un destino.</div>
  <ul id="listaDestinos"></ul>
  <div id="ubicacion-coords">üì° Esperando ubicaci√≥n...</div>
</div>

<script>
  const apiKey = "5b3ce3597851110001cf624841023b35821447ab8cb9659caa17eb9d";

  const map = L.map('map').setView([-13.53195, -71.96746], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  const provider = new GeoSearch.OpenStreetMapProvider();
  const searchControl = new GeoSearch.GeoSearchControl({
    provider,
    style: 'bar',
    searchLabel: 'Buscar lugares...',
    autoComplete: true,
    autoClose: true,
    keepResult: true
  });
  map.addControl(searchControl);

  // Estilo de la barra de b√∫squeda
  document.querySelector('.leaflet-control-geosearch').style.marginTop = '10px';
  document.querySelector('.leaflet-control-geosearch').style.marginLeft = '10px';

  let destinos = [];
  let marcadores = [];
  let rutaActual = null;
  let marcadorUbicacion = null;
  let seguirUbicacion = true;
  let mapaCentrado = false;

  function alternarSeguimiento() {
    seguirUbicacion = !seguirUbicacion;
    alert(seguirUbicacion ? "üß≠ Seguimiento activado" : "üß≠ Seguimiento desactivado");
  }

  function centrarEnMiUbicacion() {
    if (marcadorUbicacion) {
      map.setView(marcadorUbicacion.getLatLng(), 16);
    } else {
      alert("Ubicaci√≥n a√∫n no detectada.");
    }
  }

  function mostrarUbicacionEnVivo() {
    if (!navigator.geolocation) {
      alert("Tu navegador no permite ubicaci√≥n en vivo.");
      return;
    }

    navigator.geolocation.watchPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        document.getElementById("ubicacion-coords").innerText = `üìç Lat: ${lat.toFixed(5)} / Lng: ${lng.toFixed(5)}`;
        const nuevaPosicion = [lat, lng];

        if (!marcadorUbicacion) {
          marcadorUbicacion = L.marker(nuevaPosicion, {
            icon: L.icon({
              iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41]
            })
          }).addTo(map);
        } else {
          marcadorUbicacion.setLatLng(nuevaPosicion);
        }

        if (seguirUbicacion && mapaCentrado) {
          map.setView(nuevaPosicion);
        }

        if (!mapaCentrado) {
          map.setView(nuevaPosicion, 16);
          mapaCentrado = true;
        }
      },
      (err) => {
        console.error("Error de geolocalizaci√≥n:", err);
        alert("No se pudo obtener tu ubicaci√≥n.");
      },
      {
        enableHighAccuracy: true,
        maximumAge: 1000
      }
    );
  }

  mostrarUbicacionEnVivo();

  map.on('dragstart', () => {
    seguirUbicacion = false;
  });

  map.on('click', async function(e) {
    const nombre = prompt("¬øC√≥mo se llama este lugar?");
    if (!nombre) return;

    const latlng = e.latlng;
    const destino = { nombre, location: [latlng.lng, latlng.lat] };
    destinos.push(destino);

    const marcador = L.marker(latlng).addTo(map).bindPopup(nombre).openPopup();
    marcadores.push(marcador);
    actualizarLista(destinos.map(d => d.nombre));

    if (destinos.length >= 3) {
      document.getElementById("info").innerText = "Calculando ruta optimizada...";

      try {
        const body = {
          jobs: destinos.map((dest, i) => ({
            id: i + 1,
            location: dest.location
          })),
          vehicles: [{
            id: 1,
            profile: "foot-walking",
            start: destinos[0].location
          }]
        };

        const optResponse = await fetch("https://api.openrouteservice.org/optimization", {
          method: "POST",
          headers: {
            "Authorization": apiKey,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        const optData = await optResponse.json();

        if (!optData.routes || !optData.routes[0]) {
          document.getElementById("info").innerText = "‚ùå No se pudo calcular la ruta.";
          return;
        }

        const ordenOptimizado = [
          destinos[0].location,
          ...optData.routes[0].steps
            .filter(step => step.type === "job")
            .map(step => destinos[step.job - 1].location)
        ];

        const nombresOrdenados = [
          destinos[0].nombre,
          ...optData.routes[0].steps
            .filter(step => step.type === "job")
            .map(step => destinos[step.job - 1].nombre)
        ];

        actualizarLista(nombresOrdenados);

        const rutaResponse = await fetch("https://api.openrouteservice.org/v2/directions/foot-walking/geojson", {
          method: "POST",
          headers: {
            "Authorization": apiKey,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ coordinates: ordenOptimizado })
        });

        const geojson = await rutaResponse.json();

        if (rutaActual) map.removeLayer(rutaActual);
        rutaActual = L.geoJSON(geojson, {
          style: { color: 'green', weight: 5 }
        }).addTo(map);

        const distanciaKm = geojson.features[0].properties.summary.distance / 1000;
        const duracionMin = geojson.features[0].properties.summary.duration / 60;
        document.getElementById("info").innerText =
          `‚úÖ Ruta optimizada: ${distanciaKm.toFixed(2)} km en ${duracionMin.toFixed(0)} min`;

      } catch (error) {
        console.error("Error:", error);
        document.getElementById("info").innerText = "‚ùå Error al calcular la ruta.";
      }
    }
  });

  function actualizarLista(lista) {
    const ul = document.getElementById("listaDestinos");
    ul.innerHTML = "";
    lista.forEach((nombre, i) => {
      const li = document.createElement("li");
      li.textContent = `${i + 1}. ${nombre}`;
      ul.appendChild(li);
    });
  }

  function reiniciarRuta() {
    destinos = [];
    marcadores.forEach(m => map.removeLayer(m));
    marcadores = [];
    if (rutaActual) map.removeLayer(rutaActual);
    rutaActual = null;
    document.getElementById("info").innerText = "Haz clic en el mapa para agregar un destino.";
    actualizarLista([]);
  }
</script>
</body>
</html>
