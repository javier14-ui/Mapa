<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ruta Optimizada con B√∫squeda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet-Geosearch -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.css" />
  <script src="https://unpkg.com/leaflet-geosearch@3.11.0/dist/bundle.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    #panel {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 250px;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 8px;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    #listaDestinos {
      max-height: 200px;
      overflow-y: auto;
      margin: 10px 0;
      padding: 0;
      list-style: none;
    }

    #listaDestinos li {
      margin-bottom: 6px;
    }

    button {
      width: 100%;
      margin-bottom: 8px;
      padding: 8px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <button onclick="centrarUbicacion()">üìç Centrar ubicaci√≥n</button>
  <button onclick="reiniciarRuta()">üîÑ Reiniciar ruta</button>
  <ul id="listaDestinos"></ul>
</div>

<script>
  const ORS_KEY = "5b3ce3597851110001cf624841023b35821447ab8cb9659caa17eb9d";
  const map = L.map('map').setView([-13.53195, -71.96746], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  const search = new GeoSearch.GeoSearchControl({
    provider: new GeoSearch.OpenStreetMapProvider(),
    style: 'bar',
    searchLabel: 'Buscar lugar...',
    autoComplete: true,
    autoClose: true
  });
  map.addControl(search);

  let ubicacionActual = null;
  let marcadorUbicacion = null;
  navigator.geolocation.watchPosition(pos => {
    const coords = [pos.coords.latitude, pos.coords.longitude];
    ubicacionActual = coords;
    if (!marcadorUbicacion) {
      marcadorUbicacion = L.marker(coords, { icon: L.divIcon({ className: 'punto-palpitante' }) }).addTo(map);
    } else {
      marcadorUbicacion.setLatLng(coords);
    }
  });

  const style = document.createElement('style');
  style.innerHTML = `
    .punto-palpitante {
      width: 16px;
      height: 16px;
      background: red;
      border-radius: 50%;
      box-shadow: 0 0 12px red;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
  `;
  document.head.appendChild(style);

  function centrarUbicacion() {
    if (ubicacionActual) map.setView(ubicacionActual, 16);
  }

  let destinos = [];
  let marcadores = [];
  let rutaLayer = null;

  function actualizarLista() {
    const ul = document.getElementById('listaDestinos');
    ul.innerHTML = '';
    destinos.forEach((dest, i) => {
      const li = document.createElement('li');
      li.textContent = `${i + 1}. ${dest.nombre}`;
      ul.appendChild(li);
    });
  }

  async function calcularRuta() {
    if (destinos.length < 2) return;

    const jobs = destinos.map((dest, i) => ({ id: i + 1, location: [dest.lng, dest.lat] }));
    const body = {
      jobs,
      vehicles: [{ id: 1, profile: "foot-walking", start: [destinos[0].lng, destinos[0].lat] }]
    };

    const optRes = await fetch("https://api.openrouteservice.org/optimization", {
      method: 'POST',
      headers: {
        'Authorization': ORS_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    const optData = await optRes.json();
    const orden = [jobs[0].location];

    optData.routes[0].steps.forEach(step => {
      if (step.type === "job") {
        orden.push(jobs[step.job - 1].location);
      }
    });

    const rutaRes = await fetch("https://api.openrouteservice.org/v2/directions/foot-walking/geojson", {
      method: 'POST',
      headers: {
        'Authorization': ORS_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ coordinates: orden })
    });
    const rutaJson = await rutaRes.json();

    if (rutaLayer) rutaLayer.remove();
    rutaLayer = L.geoJSON(rutaJson, {
      style: { color: 'green', weight: 5 }
    }).addTo(map);
  }

  function reiniciarRuta() {
    destinos = [];
    marcadores.forEach(m => map.removeLayer(m));
    marcadores = [];
    if (rutaLayer) map.removeLayer(rutaLayer);
    rutaLayer = null;
    actualizarLista();
  }

  map.on('click', async e => {
    const nombre = prompt("Nombre del destino:");
    if (!nombre) return;

    const { lat, lng } = e.latlng;
    destinos.push({ nombre, lat, lng });
    const marker = L.marker([lat, lng]).addTo(map).bindPopup(nombre);
    marcadores.push(marker);

    actualizarLista();
    if (destinos.length >= 2) await calcularRuta();
  });
</script>
</body>
</html>
